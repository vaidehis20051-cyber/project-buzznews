{% extends "base.html" %} {% block title %}BuzzNews | Moderator  {% endblock %}
{%block logout %} 
 <div class="navbar-right">
  <a href="javascript:void(0)" class="profile-icon me-3" onclick="toggleProfile()">
    {%if user.profile_image%}
    <img src="{{ url_for('static', filename='uploads/' ~ user.profile_image) }}" 
               alt="Profile Picture" 
               height="32"
               style="border-radius: 50%"
               />
    {%else%}
    <img
      src="/static/user_logo.jpg"
      alt="Profile"
      height="32"
      style="border-radius: 50%"
    />
    {%endif%}
  </a>
  <form method="POST" action="{{ url_for('personnel_logout') }}">
  <button type="submit" class="btn logout-btn">Logout</button>
</form>

<!-- Profile Sidebar -->
<div id="profileSidebar" class="profile-sidebar">
  <div class="profile-header">
    <h4>Edit Profile</h4>
    <button class="close-btn" onclick="toggleProfile()">Ã—</button>
  </div>

  <form method="POST" action="{{ url_for('update_profile') }}" enctype="multipart/form-data">
    <input type="hidden" name="next" value="{{ request.path or '' }}">
    <!-- Profile image -->
    <div class="form-group">
      <label>Profile Image</label>
        {% if user.profile_image %}
          <img src="{{ url_for('static', filename='uploads/' ~ user.profile_image) }}" 
               alt="Profile Picture" 
               style="width:120px; height:120px; object-fit:cover; border-radius:50%; margin-bottom:10px;">
        {% else %}
          <img src="{{ url_for('static', filename='user_logo.jpg') }}" 
               alt="Profile Picture" 
               style="width:120px; height:120px; object-fit:cover; border-radius:50%; margin-bottom:10px;">
        {% endif %}
        <input type="file" name="profile_image" accept="image/*" />
        <input type="hidden" name="current_profile_image" value="{{ user.profile_image or '' }}">
      </div>

    <!-- Username -->
    <div class="form-group">
      <label>Username</label>
      {% if user.role_id in [2,3] %}
        <input type="text" name="username" value="{{ user.username }}" readonly class="form-control" />
      {% else %}
        <input type="text" name="username" value="{{ user.username }}" class="form-control" />
      {% endif %}
    </div>

    <!-- Password validation-->
      <div class="form-group">
  <label>Current Password</label>
  <div class="password-container">
    <input type="password" name="current_password" placeholder="Enter current password" required>
    <button type="button" class="toggle-password" onclick="togglePassword(this)"><i class="fa-regular fa-eye-slash"></i></button>
  </div>
</div>

<div class="form-group">
  <label>New Password</label>
  <div class="password-container">
    <input type="password" name="new_password" placeholder="Enter new password">
    <button type="button" class="toggle-password" onclick="togglePassword(this)"><i class="fa-regular fa-eye-slash"></i></button>
  </div>
</div>

    <!-- Bio -->
    <div class="form-group">
      <label>Bio</label>
      <textarea name="bio" rows="3" placeholder="Write about yourself..." style="padding:5px">{{ user.bio }}</textarea>
      <input type="hidden" name="current_bio" value="{{ user.bio }}">
    </div>

    <!-- Save -->
    <button type="submit" class="btn save-btn">Save Changes</button>
  </form>
</div>
</div>
</div>
{% endblock %}

{% block content %}
<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="main-content">
  
  <div class="journalist-dashboard">
    <aside class="sidebar">
      <ul>
        <li><a href="{{ url_for('moderator_dashboard', tab='articles') }}"><i class="fa-regular fa-folder-open"></i> Pending Journalist Articles</a></li>
        <li><a href="{{ url_for('moderator_dashboard', tab='localVoices') }}"><i class="fa-regular fa-folder-open"></i> Pending Local Voices</a></li>
        <li><a href="{{ url_for('moderator_dashboard', tab='approved') }}"><i class="fa-regular fa-newspaper"> </i> Approved Articles</a></li>
        <li><a href="{{ url_for('moderator_dashboard', tab='rejected') }}"><i class="fa-regular fa-rectangle-xmark"></i> Rejected Articles</a></li>
      </ul>
    </aside>

    <main class="dashboard-main">
      <div class="datetime-container">
        <span id="date"></span> | <span id="time"></span>
      </div>

      <section class="dashboard-header">
        <h2>
          {% if active_tab == 'articles' %}Pending Journalist Articles
          {% elif active_tab == 'localVoices' %}Pending Local Voices
          {% elif active_tab == 'approved' %}Approved Articles
          {% elif active_tab == 'rejected' %}Rejected Articles
          {% endif %}
        </h2>
      </section>

      <section class="article-list">
        {% set tab_key = {
          'articles': 'pending',
          'localVoices': 'pending',
          'approved': 'approved',
          'rejected': 'rejected'
        }[active_tab] if active_tab in ['articles','localVoices','approved','rejected'] else None %}

        {% if active_tab != 'comments' %}
          {% if tab_key and articles[tab_key] %}
            {% for article in articles[tab_key] %}
              {% if active_tab == 'articles' and not article.is_local_voice or active_tab == 'localVoices' and article.is_local_voice or active_tab in ['approved','rejected'] %}
                <div class="article-card">
                  <h3>
                    {% if active_tab in ['articles','localVoices'] %}
                      <a href="javascript:void(0);" onclick="openModal({{ article.id }})">{{ article.title }}</a>
                    {% elif active_tab in ['approved','rejected'] %}
                      <a href="{{ url_for('view_article', article_id=article.id, next='moderator_dashboard') }}">
                          {{ article.title }}
                      </a>
                    {% else %}
                      {{ article.title }}
                    {% endif %}
                  </h3>
                  <p>{{ article.content[:100] }}...</p>
                  <span class="status {{ article.status }}">{{ article.status|capitalize }}</span>
                  <div class="actions">
                    {% if active_tab in ['approved','rejected'] %}
                    <button type="submit" name="action" value="delete" class="btn btn-danger btn-sm" style="margin-left: 10px;" onclick="return confirm('Are you sure you want to delete this article?');">Delete</button>
                    {% endif %}
                  </div>
                </div>

              {% if active_tab in ['articles','localVoices'] %}
              <!-- Modal -->
              <div id="modal-{{ article.id }}" class="article-modal d-none">
                <div class="modal-content">
                  <span class="close-btn" onclick="closeModal({{ article.id }})">&times;</span>
                  <h4>{{ article.title }}</h4>
                  <p><strong>Author:</strong> {{ article.author if article.author else 'N/A' }}</p>
                  {% if article.image_url %}
                      <img src="{{ url_for('static', filename='uploads/' ~ article.image_url) }}"
                           alt="Article Image"
                           style="width: 100%; max-height: 300px; object-fit: cover; margin-top: 10px; border-radius: 5px;">
                      {% endif %}
                  <p>{{ article.content }}</p>
                  
                    <form method="POST" action="{{url_for('moderator_action')}}" style="margin-top:10px;">
                      <input type="hidden" name="article_id" value="{{ article.id }}">
                      <input type="hidden" name="next" value="{{ request.path }}">

                      <button type="submit" name="action" value="approved" class="btn btn-approve btn-sm">Approve</button>

                      <button type="submit" name="action" value="rejected" class="btn btn-reject btn-sm" style="margin-left: 10px;" onclick="showRejectReason({{ article.id }})">
                        Reject
                      </button>
                        <div id="reject-reason-{{ article.id }}" class="reject-modal">
                          <div class="reject-modal-content">
                            <button class="close-btn" onclick="closeRejectModal({{ article.id }})">&times;</button>

                            <select name="rejection_reason" class="form-select" required>
                              <option value="">-- Select Reason --</option>
                              <option value="Low Quality">Low Quality</option>
                              <option value="Factually Incorrect">Factually Incorrect</option>
                              <option value="Irrelevant Content">Irrelevant Content</option>
                              <option value="Duplicate Article">Duplicate Article</option>
                            </select>
                          
                            <textarea name="custom_comment" class="form-control" rows="2" placeholder="Additional comments (optional)"></textarea>
                          
                            <button type="submit" name="action" value="rejected" class="btn btn-danger">Submit Rejection</button>
                          </div>
                        </div>
                      <button type="submit" name="action" value="delete" class="btn btn-reject btn-sm" style="margin-left: 10px;" onclick="return confirm('Are you sure you want to delete this article?');">Delete</button>
                    </form> 

                </div>
              </div>
              {% endif %}
              {% endif %}
            {% endfor %}
          {% else %}
            <p>No articles in this section.</p>
          {% endif %}
        {% else %}
          
        {% endif %}
      </section>
    </main>
  </div>
</div>
<!-- Floating Action Button --> 
 <div class="floating-btn" onclick="togglePopup()" title="Add">+</div> 
 <div id="popup-options" class="popup-options d-none"> 
  <button class="btn popup-btn" onclick="showUserForm()"><i class="fa-solid fa-user"></i> Add Moderator/Journalist</button> 
 </div> 
 <!-- Add User Form --> 
  <div id="add-user-form" class="add-user-form d-none"> 
    <form method="POST" action="{{ url_for('add_user') }}" class="user-form"> 
      <input type="hidden" name="next" value="{{ request.path }}">
      <h5>Add New User</h5> 
      <input type="text" name="username" placeholder="Username" required /> 
      <div class="password-container">
        <input type="password" name="password" placeholder="Password" required /> 
        <button type="button" class="toggle-password" onclick="togglePassword(this)"><i class="fa-regular fa-eye-slash"></i></button>
      </div>
      <select name="role_id" required> 
        <option value="" disabled selected>Select Role</option> 
          <option value="2">Moderator</option> 
          <option value="3">Journalist</option> 
        </select> 
      <select name="district_id" id="district" required> 
        <option value="" disabled selected>Select District</option> 
        {% for district in districts %} 
        <option value="{{ district.id }}">
          {{ district.name }}
        </option> 
        {% endfor %} 
      </select> 
      <div class="form-actions"> 
        <button type="submit" class="btn submit-btn">Submit</button> 
        <button type="button" class="btn cancel-btn" onclick="hideUserForm()">Cancel</button> 
      </div> 
    </form> 
  </div>
{% endblock %}

{% block script %} 
<script>
  function updateDateTime() {
        const now = new Date();

        const dateOptions = { day: "2-digit", month: "long", year: "numeric" };
        const timeOptions = {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false,
        };

        const dateStr = now.toLocaleDateString("en-GB", dateOptions);
        const timeStr = now.toLocaleTimeString("en-GB", timeOptions);

        document.getElementById("date").textContent = dateStr;
        document.getElementById("time").textContent = timeStr;
      }
      document.addEventListener("DOMContentLoaded", function () {
        updateDateTime();
        setInterval(updateDateTime, 1000);
      });
    function openModal(id) { document.getElementById('modal-' + id).classList.remove('d-none'); }
function closeModal(id) { document.getElementById('modal-' + id).classList.add('d-none'); }

function togglePopup() { document.getElementById("popup-options").classList.toggle("d-none"); }
function showUserForm() { document.getElementById("popup-options").classList.add("d-none"); document.getElementById("add-user-form").classList.remove("d-none"); }
function hideUserForm() { document.getElementById("add-user-form").classList.add("d-none"); }
function toggleProfile() { document.getElementById("profileSidebar").classList.toggle("active"); }
function togglePassword(button) {
    const input = button.previousElementSibling; 
    const icon = button.querySelector('i');      
    if (input.type === "password") { input.type = "text"; icon.classList.remove("fa-eye-slash"); icon.classList.add("fa-eye"); }
    else { input.type = "password"; icon.classList.remove("fa-eye"); icon.classList.add("fa-eye-slash"); }
}
function togglePopup() {
    const popup = document.getElementById("popup-options");
    popup.classList.toggle("d-none");
}
document.addEventListener("click", function(event) {
    const popup = document.getElementById("popup-options");
    const btn = document.querySelector(".btn-floating");
    
    if (!popup.classList.contains("d-none") && 
        !popup.contains(event.target) && 
        !btn.contains(event.target)) {
        popup.classList.add("d-none");
    }
});
function redirectToCreateArticle() { window.location.href = "/article"; };
function openRejectModal(articleId) {
    document.getElementById(`reject-reason-${articleId}`).classList.add('active');
}

function closeRejectModal(articleId) {
    document.getElementById(`reject-reason-${articleId}`).classList.remove('active');
}
function showRejectReason(articleId) {
    document.getElementById(`reject-reason-${articleId}`).classList.add('active');
}
</script>
{% endblock %}